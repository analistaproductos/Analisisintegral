<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>An√°lisis Integral ‚Äî Dashboard Comercial (Cotrafa Social)</title>
  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png"/>
  <style>
    :root{--primary:#003366;--accent:#00AEEF;--success:#7CC242;--warning:#F39200;--navy:#002f5a;--bg:#F5F7FB;--surface:#fff;--ink:#0f172a;--muted:#475569;--ring:rgba(0,174,239,.35);--shadow:0 10px 30px rgba(2,14,39,.08);--radius:16px}
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{line-height:1.1;color:var(--navy)} h1{font-size:clamp(28px,3.6vw,40px)} h2{font-size:clamp(18px,2.2vw,22px)}
    .container{max-width:1220px;margin:0 auto;padding:0 20px}
    header.topbar{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #e9eff6}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:12px 0}
    .brand{display:flex;align-items:center;gap:12px}.brand img{height:42px}.brand .logotxt{font-weight:800;color:var(--primary)}
    .panel{background:var(--surface);border:1px solid #e7eef7;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .toolbar{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin:18px 0}
    .file{display:flex;flex-wrap:wrap;align-items:center;gap:12px}
    .file input[type=file]{padding:10px;border-radius:12px;border:1px dashed #cfe5f4;background:#fafcff}
    .filters{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .filter{display:flex;flex-direction:column;gap:6px}
    .filter label{font-size:12px;font-weight:700;color:#334155}
    .filter input, .filter select{padding:10px;border-radius:12px;border:1px solid #dbe7f3;background:#fff}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;font-weight:700;border:1px solid transparent;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
    .btn-outline{background:#fff;border-color:#dbe7f3;color:var(--primary)}
    .btn-warning{background:linear-gradient(135deg,var(--warning),#ffc46b);color:#432c00}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f1f7fb;border:1px solid #d7e8f6;color:#0b3a57;padding:6px 10px;border-radius:999px;font-size:12px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:12px 0 22px}
    .kpi{position:relative;background:linear-gradient(135deg,#fff,#f7fbff);border:1px solid #e7eef7;border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    .kpi .label{display:flex;align-items:center;gap:8px;color:#334155;font-size:12px;font-weight:700}
    .kpi .value{font-size:26px;font-weight:800;color:var(--primary);margin-top:6px}
    .charts{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .card{background:var(--surface);border:1px solid #e7eef7;border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px;font-size:16px}
    .card canvas{width:100%!important;height:320px!important}
    footer{margin:26px 0 40px}.foot{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between}.small{font-size:12px;color:#64748b}
    @media (max-width:1100px){.toolbar{grid-template-columns:1fr}.charts{grid-template-columns:1fr 1fr}}
    @media (max-width:720px){.filters{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}.charts{grid-template-columns:1fr}}
    :focus-visible{outline:3px solid var(--ring);outline-offset:3px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container nav">
      <div class="brand" aria-label="Cotrafa Social">
        <img src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Logo Cotrafa Social"/>
        <span class="logotxt">Cotrafa Social</span>
      </div>
      <div class="actions">
        <button class="btn btn-outline" id="btnResetAll" title="Limpiar filtros">üßπ Limpiar</button>
        <button class="btn btn-outline" id="btnLogoBase64" title="Fijar logo en PDF (base64)">üñºÔ∏è Logo en PDF</button>
        <button class="btn btn-outline" id="btnOrg" title="Editar datos de la organizaci√≥n">üè∑Ô∏è Datos</button>
        <button class="btn btn-primary" id="btnReport" title="Descargar informe ejecutivo">üìÑ Informe PDF</button>
      </div>
    </div>
    <input id="logoFile" type="file" accept="image/*" style="display:none" />
  </header>

  <main class="container">
    <section class="toolbar">
      <div class="panel" aria-labelledby="tituloCarga">
        <h2 id="tituloCarga">Cargar datos</h2>
        <div class="file">
          <input type="file" id="csvFile" accept=".csv" aria-label="Seleccionar archivo CSV"/>
          <div class="meta">CSV con ; o , en UTF‚Äë8.</div>
        </div>
        <div class="chips" id="chips"></div>
      </div>
      <div class="panel" aria-labelledby="tituloFiltros">
        <h2 id="tituloFiltros">Filtros</h2>
        <div class="filters" id="filters"></div>
        <div class="actions"><button class="btn btn-warning" id="btnRefresh">‚Üª Refrescar filtros</button></div>
      </div>
    </section>

    <section class="kpis" id="kpiSection"></section>

    <section class="charts" id="chartSection"></section>
  </main>

  <footer class="container">
    <div class="panel foot">
      <div class="brand">
        <img src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Logo Cotrafa Social"/>
        <div>
          <div class="logotxt">Cotrafa Social</div>
          <div class="small">Dashboard comercial ‚Äî versi√≥n ejecutiva y accesible</div>
        </div>
      </div>
      <div class="small">¬© <span id="year"></span> Cotrafa Social ‚Ä¢ Reporte PDF y filtros por clic</div>
    </div>
  </footer>

  <div id="loading" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999;color:#fff;font-weight:800">Cargando datos‚Ä¶</div>

  <script>
  // ====== Marca & Organizaci√≥n ======
  const BRAND = { logoURL:'https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png', logoDataURI:null };
  const ORG = { nombre:'Cotrafa Social', nit:'NIT 000.000.000-0', email:'contacto@cotrafasocial.com', telefono:'+57 (000) 000 00 00', web:'https://cotrafasocial.com', watermark:'COTRAFA SOCIAL ‚Äî CONFIDENCIAL' };
  (function(){ try{
    const s=localStorage.getItem('cotrafa_logo_base64'); if(s) BRAND.logoDataURI=s;
    const o=localStorage.getItem('cotrafa_org_info');
    if(o){ const parsed=JSON.parse(o); if(parsed && typeof parsed==='object'){
      ORG.nombre=parsed.nombre||ORG.nombre;
      ORG.nit=parsed.nit||ORG.nit;
      ORG.email=parsed.email||ORG.email;
      ORG.telefono=parsed.telefono||ORG.telefono;
      ORG.web=parsed.web||ORG.web;
    }}
  }catch(e){} preloadLogo(); })();
  async function preloadLogo(){ if(BRAND.logoDataURI) return; try{ const r=await fetch(BRAND.logoURL,{mode:'cors'}); const b=await r.blob(); BRAND.logoDataURI=await blobToDataURL(b);}catch(e){} }
  function blobToDataURL(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }

  // ====== Estado ======
  let rawData=[]; let filteredData=[]; const charts={};
  const filterConfigs=[{key:'Ciudad',label:'Ciudad'},{key:'Estado',label:'Estado'},{key:'CategoriaEdad',label:'Categor√≠a Edad'}];
  const chartFilterState={month:null,year:null,categoriaEdad:null,estado:null,ciudad:null,mesesSinPagarRange:null};
  const chartDimensionMap={ chartMesAfiliacion:'month', chartAnoAfiliacion:'year', chartCategoriaEdad:'categoriaEdad', chartEstado:'estado', chartCiudad:'ciudad', chartMesesSinPagar:'mesesSinPagarRange'};
  Chart.defaults.font.family='Inter, system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif'; Chart.defaults.color='#334155';

  // ====== Inicio ======
  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('year').textContent=new Date().getFullYear();
    initFilters(); initKPISection(); initCharts();
    document.getElementById('csvFile').addEventListener('change',handleFileUpload);
    document.getElementById('btnResetAll').addEventListener('click',resetAll);
    document.getElementById('btnOrg').addEventListener('click',editOrg);
    document.getElementById('btnReport').addEventListener('click',generateReport);
    document.getElementById('btnRefresh').addEventListener('click',()=>{populateFilterOptions(); applyFilters();});
    const logoBtn=document.getElementById('btnLogoBase64'); const logoFile=document.getElementById('logoFile');
    logoBtn.addEventListener('click',()=>logoFile.click());
    logoFile.addEventListener('change',async(e)=>{ const f=e.target.files[0]; if(!f) return; const dataURL=await blobToDataURL(f); BRAND.logoDataURI=dataURL; try{localStorage.setItem('cotrafa_logo_base64',dataURL);}catch(err){} toast('Logo incrustado para PDF'); });
  });

  // ====== Filtros ======
  function initFilters(){ const wrap=document.getElementById('filters'); wrap.innerHTML='';
    filterConfigs.forEach(cfg=>{ const box=document.createElement('div'); box.className='filter';
      const lab=document.createElement('label'); lab.textContent=cfg.label; box.appendChild(lab);
      const search=document.createElement('input'); search.type='text'; search.placeholder='Buscar‚Ä¶'; box.appendChild(search);
      const sel=document.createElement('select'); sel.id='filter-'+cfg.key; sel.multiple=true; sel.size=6; box.appendChild(sel);
      search.addEventListener('input',()=>{ const term=search.value.toLowerCase(); Array.from(sel.options).forEach((o,i)=>{ if(i===0||o.selected) return; o.hidden=!o.textContent.toLowerCase().includes(term); }); });
      sel.addEventListener('change',applyFilters); wrap.appendChild(box);
    }); populateFilterOptions(); }
  function populateFilterOptions(){ filterConfigs.forEach(cfg=>{ const sel=document.getElementById('filter-'+cfg.key); if(!sel) return; const vals=new Set(); rawData.forEach(r=>{ if(r[cfg.key]) vals.add(String(r[cfg.key])); }); const allOpt=document.createElement('option'); allOpt.value='__all__'; allOpt.textContent='(Todos)'; allOpt.selected=true; sel.innerHTML=''; sel.appendChild(allOpt); Array.from(vals).sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); }); }
  function activeChips(){ const chips=document.getElementById('chips'); chips.innerHTML=''; filterConfigs.forEach(cfg=>{ const sel=document.getElementById('filter-'+cfg.key); if(!sel) return; Array.from(sel.selectedOptions).forEach(opt=>{ if(opt.value==='__all__') return; const c=chip(`${cfg.label}: ${opt.value}`,()=>{ opt.selected=false; applyFilters(); }); chips.appendChild(c); }); }); const map={month:'Mes',year:'A√±o',categoriaEdad:'Cat. Edad',estado:'Estado',ciudad:'Ciudad',mesesSinPagarRange:'Meses sin pagar'}; Object.entries(chartFilterState).forEach(([k,v])=>{ if(!v) return; const c=chip(`${map[k]}: ${v}`,()=>{ chartFilterState[k]=null; applyFilters(); }); chips.appendChild(c); }); }
  function chip(text,onRemove){ const d=document.createElement('span'); d.className='chip'; d.innerHTML=`${text} <button aria-label="Quitar">‚úï</button>`; d.querySelector('button').addEventListener('click',onRemove); return d; }
  function resetAll(){ filterConfigs.forEach(cfg=>{ const sel=document.getElementById('filter-'+cfg.key); if(!sel) return; Array.from(sel.options).forEach((o,i)=>o.selected=(i===0)); }); Object.keys(chartFilterState).forEach(k=>chartFilterState[k]=null); applyFilters(); }

  // ====== Carga & normalizaci√≥n ======
  async function handleFileUpload(e){ const file=e.target.files[0]; if(!file) return; showLoading(true);
    Papa.parse(file,{header:true,skipEmptyLines:true,encoding:'UTF-8',dynamicTyping:false,complete:(res)=>{ rawData=res.data.map(cleanRow); populateFilterOptions(); applyFilters(); showLoading(false); }, error:(err)=>{ console.error(err); showLoading(false); alert('No se pudo procesar el CSV. Verifique delimitador y UTF-8.'); }});
  }
  function cleanRow(row){ const out={}; for(const k in row){ if(!row.hasOwnProperty(k)) continue; const key=String(k).trim(); let nk=key; if(/^ciudad$/i.test(key)) nk='Ciudad'; else if(/^estado$/i.test(key)) nk='Estado'; else if(/^(categoria\s*edad|categor√≠a\s*edad|categoria_edad|categor√≠a_edad)$/i.test(key)) nk='Categoria Edad'; out[nk]=String(row[k]??'').trim(); }
    if(out['Edad']) out['Edad']=parseInt(out['Edad'],10)||0;
    if(out['% pago']) out['PctPago']=parseFloat(out['% pago'].replace(/[^0-9.,-]/g,'').replace(',','.'))||0;
    if(out['% no pago']) out['PctNoPago']=parseFloat(out['% no pago'].replace(/[^0-9.,-]/g,'').replace(',','.'))||0;
    if(out['Cuotas pagadas']) out['CuotasPagadas']=parseFloat(out['Cuotas pagadas'].replace(/[^0-9.,-]/g,'').replace(',','.'))||0;
    if(out['Meses afiliado']) out['MesesAfiliado']=parseInt(out['Meses afiliado'],10)||0;
    if(out['Meses sin pagar']) out['Meses_sin_pagar']=parseFloat(out['Meses sin pagar'].replace(/[^0-9.,-]/g,'').replace(',','.'))||0;
    if(out['A√±o de afiliaci√≥n']||out['A√±oAfiliacion']||out['AnoAfiliacion']) out['AnoAfiliacion']=parseInt(out['A√±o de afiliaci√≥n']||out['A√±oAfiliacion']||out['AnoAfiliacion'],10)||null;
    if(out['Mes de afiliaci√≥n']||out['MesAfiliacion']){ let m=out['Mes de afiliaci√≥n']||out['MesAfiliacion']; const map={"enero":1,"febrero":2,"marzo":3,"abril":4,"mayo":5,"junio":6,"julio":7,"agosto":8,"septiembre":9,"setiembre":9,"octubre":10,"noviembre":11,"diciembre":12}; out['MesAfiliacion']=isNaN(parseInt(m,10))? map[String(m).toLowerCase()]||null:parseInt(m,10); }
    if(out['Categoria Edad']) out['CategoriaEdad']=out['Categoria Edad'];
    if(out['renovacion']!==undefined) out['Renovacion']=String(out['renovacion']).toLowerCase();
    return out; }

  // ====== Aplicaci√≥n de filtros & KPIs ======
  function applyFilters(){ filteredData=rawData.filter(row=>{ const okSelects=filterConfigs.every(cfg=>{ const sel=document.getElementById('filter-'+cfg.key); if(!sel) return true; const selected=Array.from(sel.selectedOptions).map(o=>o.value); if(!selected.length||selected.includes('__all__')) return true; const cell=row[cfg.key]||''; return selected.some(v=>String(cell).toLowerCase()===String(v).toLowerCase()); }); return okSelects && matchesChartFilters(row); }); activeChips(); updateKPIs(); updateCharts(); }
  function matchesChartFilters(row){ if(chartFilterState.month){ const names=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let m=row.MesAfiliacion?parseInt(row.MesAfiliacion,10):null; const lbl=m?(names[m]||String(m)):null; if(!lbl||lbl.toLowerCase()!==chartFilterState.month.toLowerCase()) return false; } if(chartFilterState.year){ const y=row.AnoAfiliacion||null; if(!y||String(y)!==String(chartFilterState.year)) return false; } if(chartFilterState.categoriaEdad){ const ce=row.CategoriaEdad||'Desconocido'; if(ce.toLowerCase()!==chartFilterState.categoriaEdad.toLowerCase()) return false; } if(chartFilterState.estado){ const est=row.Estado||'Desconocido'; if(String(est).toLowerCase()!==String(chartFilterState.estado).toLowerCase()) return false; } if(chartFilterState.ciudad){ const ciu=row.Ciudad||'Desconocido'; if(String(ciu).toLowerCase()!==String(chartFilterState.ciudad).toLowerCase()) return false; } if(chartFilterState.mesesSinPagarRange){ const m=row.Meses_sin_pagar!==undefined? row.Meses_sin_pagar : null; let r=null; if(m!==null && !isNaN(m)){ if(m===0) r='0'; else if(m<=3) r='1-3'; else if(m<=6) r='4-6'; else if(m<=12) r='7-12'; else r='>12'; } if(!r||r!==chartFilterState.mesesSinPagarRange) return false; } return true; }
  function updateKPIs(){ const total=filteredData.length; setKPI('%Pago',pctPago()); setKPI('%NoPago',pctNoPago()); setKPI('Cantidad',formatNumber(total)); setKPI('Cantidad%',formatPercentage(rawData.length?(total/rawData.length*100):0)); }
  function pctPago(){ let s=0,c=0; filteredData.forEach(r=>{ let p=r.PctPago; let np=r.PctNoPago; if(p===undefined && r.CuotasPagadas!==undefined && r.MesesAfiliado>0){ p=(r.CuotasPagadas/r.MesesAfiliado)*100; np=100-p; } if(p!==undefined){ s+=p; c++; }}); return formatPercentage(c? s/c : 0); }
  function pctNoPago(){ let s=0,c=0; filteredData.forEach(r=>{ let p=r.PctPago; let np=r.PctNoPago; if(np===undefined && r.CuotasPagadas!==undefined && r.MesesAfiliado>0){ p=(r.CuotasPagadas/r.MesesAfiliado)*100; np=100-p; } if(np!==undefined){ s+=np; c++; }}); return formatPercentage(c? s/c : 0); }
  function setKPI(name,val){ const id='kpi-'+name.replace(/\s+/g,''); const el=document.getElementById(id); if(el) el.textContent=val; }
  function initKPISection(){ const root=document.getElementById('kpiSection'); root.innerHTML=''; const items=['% Pago','% No Pago','Cantidad','Cantidad %']; items.forEach(label=>{ const d=document.createElement('div'); d.className='kpi'; d.innerHTML=`<div class="label">${iconFor(label)} ${label}</div><div class="value" id="kpi-${label.replace(/\s+/g,'')}">-</div>`; root.appendChild(d); }); }
  function iconFor(label){ if(label.includes('% Pago')) return '‚úÖ'; if(label.includes('% No Pago')) return '‚ùå'; if(label.includes('Cantidad %')) return '‚è±Ô∏è'; return 'üìä'; }

  // ====== Gr√°ficos ======
  function initCharts(){ const chartSection=document.getElementById('chartSection'); chartSection.innerHTML=''; const cfgs=[{id:'chartMesAfiliacion',title:'Afiliaciones por Mes',type:'bar'},{id:'chartAnoAfiliacion',title:'Afiliaciones por A√±o',type:'bar'},{id:'chartCategoriaEdad',title:'Distribuci√≥n por Categor√≠a de Edad',type:'bar'},{id:'chartEstado',title:'Distribuci√≥n por Estado',type:'bar'},{id:'chartCiudad',title:'Distribuci√≥n por Ciudad',type:'pie'},{id:'chartMesesSinPagar',title:'Meses sin Pagar (rangos)',type:'bar'}]; cfgs.forEach(c=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3>${c.title}</h3><canvas id="${c.id}" aria-label="${c.title}"></canvas>`; chartSection.appendChild(card); const ctx=document.getElementById(c.id).getContext('2d'); charts[c.id]=new Chart(ctx,{type:c.type,data:{labels:[],datasets:[]},options:baseChartOptions(c)}); }); }
  function baseChartOptions(cfg){ const common={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:cfg.type==='pie'},tooltip:{enabled:true}}}; if(cfg.type!=='pie'){ common.scales={x:{grid:{color:'rgba(2,14,39,.06)'}},y:{grid:{color:'rgba(2,14,39,.06)'}}}; }
    const dim=chartDimensionMap[cfg.id]; if(dim){ common.onClick=(evt)=>{ const a=charts[cfg.id].getElementsAtEventForMode(evt,'nearest',{intersect:true},true); if(a&&a.length){ const i=a[0].index; const label=charts[cfg.id].data.labels[i]; chartFilterState[dim]=(chartFilterState[dim]===label?null:label); applyFilters(); }else{ chartFilterState[dim]=null; applyFilters(); } }; }
    return common; }
  function updateCharts(){ chartMesAfiliacion(); chartAnoAfiliacion(); chartCategoriaEdad(); chartEstado(); chartCiudad(); chartMesesSinPagar(); }
  function chartMesAfiliacion(){ const counts={}; filteredData.forEach(r=>{ let m=r.MesAfiliacion; if(m) counts[m]=(counts[m]||0)+1; }); const names=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; const labels=Object.keys(counts).sort((a,b)=>a-b).map(k=>names[k]||k); const data=labels.map(l=>counts[names.indexOf(l)]||0); setBar('chartMesAfiliacion',labels,data,'Afiliaciones',true,'N√∫mero de Afiliaciones'); }
  function chartAnoAfiliacion(){ const c={}; filteredData.forEach(r=>{ let y=r.AnoAfiliacion; if(y) c[y]=(c[y]||0)+1; }); const labels=Object.keys(c).sort(); const data=labels.map(l=>c[l]); setBar('chartAnoAfiliacion',labels,data,'Afiliaciones',true,'N√∫mero de Afiliaciones','A√±o'); }
  function chartCategoriaEdad(){ const c={}; filteredData.forEach(r=>{ const k=r.CategoriaEdad||'Desconocido'; c[k]=(c[k]||0)+1; }); const labels=Object.keys(c); const data=labels.map(l=>c[l]); setBar('chartCategoriaEdad',labels,data,'Afiliados',true,'Afiliados','Categor√≠a de Edad'); }
  function chartEstado(){ const c={}; filteredData.forEach(r=>{ const k=r.Estado||'Desconocido'; c[k]=(c[k]||0)+1; }); const labels=Object.keys(c); const data=labels.map(l=>c[l]); setBar('chartEstado',labels,data,'Afiliados',true,'Afiliados','Estado'); }
  function chartCiudad(){ const counts={}; filteredData.forEach(r=>{ const k=r.Ciudad||'Desconocido'; counts[k]=(counts[k]||0)+1; }); const entries=Object.entries(counts).sort((a,b)=>b[1]-a[1]); const max=9; let other=0; const labels=[]; const data=[]; entries.forEach((e,i)=>{ if(i<max){ labels.push(e[0]); data.push(e[1]); } else other+=e[1]; }); if(other>0){ labels.push('Otros'); data.push(other); } const chart=charts['chartCiudad']; chart.data.labels=labels; chart.data.datasets=[{label:'Afiliados',data,backgroundColor:palette(labels.length),borderColor:'#fff',borderWidth:2}]; chart.update(); }
  function chartMesesSinPagar(){ const ranges=[{label:'0',min:0,max:0},{label:'1-3',min:1,max:3},{label:'4-6',min:4,max:6},{label:'7-12',min:7,max:12},{label:'>12',min:13,max:Infinity}]; const c={}; ranges.forEach(r=>c[r.label]=0); filteredData.forEach(r=>{ const v=r.Meses_sin_pagar!==undefined? r.Meses_sin_pagar:null; if(v!==null && !isNaN(v)){ const R=ranges.find(x=>v>=x.min && v<=x.max); if(R) c[R.label]++; }}); const labels=ranges.map(r=>r.label); const data=labels.map(l=>c[l]); setBar('chartMesesSinPagar',labels,data,'Afiliados',true,'Afiliados','Meses sin Pagar'); }
  function setBar(id,labels,data,dsLabel,rounded=false,yTitle='',xTitle=''){ const chart=charts[id]; chart.data.labels=labels; chart.data.datasets=[{label:dsLabel,data,backgroundColor:palette(labels.length),borderRadius:rounded?6:0,borderSkipped:false,borderColor:'rgba(255,255,255,.6)',borderWidth:1}]; if(chart.options.scales){ chart.options.scales.y.title={display:!!yTitle,text:yTitle,color:'#334155'}; chart.options.scales.x.title={display:!!xTitle,text:xTitle,color:'#334155'}; } chart.update(); }
  function palette(n){ const base=['#F39200','#009B3E','#003366','#00AEEF','#F7C600','#004E8E','#00A6A6','#FFA500','#006633']; const out=[]; for(let i=0;i<n;i++){ out.push(base[i%base.length]); } return out; }

  // ====== KPIs utils ======
  function formatNumber(num,dec=0){ return Number(num||0).toLocaleString('es-CO',{minimumFractionDigits:dec,maximumFractionDigits:dec}); }
  function formatPercentage(v){ return `${Number(v||0).toFixed(1)}%`; }
  function showLoading(show){ document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

  // ====== PDF Ejecutivo ======
  async function generateReport(){ try{ if(!window.jspdf||!window.jspdf.jsPDF){ alert('No se pudo cargar jsPDF.'); return; } const {jsPDF}=window.jspdf; const doc=new jsPDF('l','mm','a4'); const pageW=doc.internal.pageSize.getWidth(); const pageH=doc.internal.pageSize.getHeight(); const M=14; drawCover(doc,pageW,pageH,M); drawWatermark(doc,pageW,pageH); doc.addPage('a4','l'); drawHeader(doc); const resumen=buildInsights(); let y=28; doc.setTextColor(15,23,42); doc.setFontSize(14); doc.text('Resumen Ejecutivo',M,y); y+=6; doc.setFontSize(9); doc.setTextColor(51,65,85); resumen.forEach(line=>{ const used=doc.splitTextToSize('‚Ä¢ '+line,pageW-2*M); doc.text(used,M,y); y+=(used.length*4+2); }); y+=6; const kpiY=y+2; const boxW=(pageW-2*M-3*6)/4; const kpiVals=[["% Pago",pctPago()],["% No Pago",pctNoPago()],["Cantidad",formatNumber(filteredData.length)],["Cobertura",formatPercentage(rawData.length?(filteredData.length/rawData.length*100):0)]]; for(let i=0;i<4;i++){ const x=M+i*(boxW+6); drawKPI(doc,x,kpiY,boxW,20,kpiVals[i][0],kpiVals[i][1]); }
    // P√°ginas de gr√°ficas: 1 por p√°gina, ancho completo para m√°xima legibilidad
    addFooter(doc); doc.addPage('a4','l'); drawHeader(doc);
    const interGap=8; const titleY=24; const chartTopY=titleY+10; const footerReserve=18;
    const gW=(pageW-2*M); const gH=(pageH-chartTopY-footerReserve);
    const ids=['chartMesAfiliacion','chartAnoAfiliacion','chartCategoriaEdad','chartEstado','chartCiudad','chartMesesSinPagar'];
    for(let i=0;i<ids.length;i++){
      if(i>0){ addFooter(doc); doc.addPage('a4','l'); drawHeader(doc); }
      const chartTitle = getChartTitle(ids[i]);
      sectionTitle(doc, chartTitle || 'Gr√°fica', M, titleY);
      const filtersText = getActiveFiltersText();
      if(filtersText){ doc.setTextColor(71,85,105); doc.setFontSize(8); doc.text(filtersText, M, titleY+5); }
      const x=M; const yy=chartTopY;
      drawChartCard(doc,x,yy,gW,gH,ids[i]);
    }
    addFooter(doc); downloadPDF(doc,'informe_ejecutivo.pdf'); }catch(err){ console.error(err); alert('Error al generar el informe.'); } }
  function drawHeader(doc){ const pageW=doc.internal.pageSize.getWidth(); const headH=20; doc.setFillColor(0,47,90); doc.rect(0,0,pageW,headH,'F'); if(BRAND.logoDataURI){ doc.addImage(BRAND.logoDataURI,'PNG',10,3,14,14);} doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text('Informe Ejecutivo ‚Äî Cotrafa Social',28,8); doc.setFontSize(9); doc.text(new Date().toLocaleString('es-CO'),28,15); drawContactInfoRight(doc, pageW-10, 15, true); }
  function drawKPI(doc,x,y,w,h,label,value){ doc.setDrawColor(215,232,246); doc.setFillColor(255,255,255); doc.roundedRect(x,y,w,h,2,2,'FD'); doc.setTextColor(51,65,85); doc.setFontSize(9); doc.text(label,x+4,y+6); doc.setTextColor(0,51,102); doc.setFontSize(14); doc.text(String(value),x+4,y+14); }
  function drawChartCard(doc,x,y,w,h,cid){
    doc.setDrawColor(215,232,246); doc.setFillColor(255,255,255);
    doc.roundedRect(x,y,w,h,2,2,'FD');
    const chart=charts[cid]; if(!chart||!chart.canvas) return;
    const img=captureChartImage(cid, w-8, h-18) || chart.canvas.toDataURL('image/png');
    const innerX=x+4, innerY=y+12, innerW=w-8, innerH=h-18;
    // Ajustar por relaci√≥n de aspecto usando metadatos reales de la imagen
    let drawW=innerW, drawH=innerH, offX=innerX, offY=innerY;
    try{
      const props = doc.getImageProperties(img);
      const imgRatio = props.width / props.height;
      const boxRatio = innerW / innerH;
      if (imgRatio > boxRatio){
        drawW = innerW; drawH = innerW / imgRatio;
      } else {
        drawH = innerH; drawW = innerH * imgRatio;
      }
      offX = innerX + (innerW - drawW) / 2;
      offY = innerY + (innerH - drawH) / 2;
    }catch(_){ /* si falla, usamos innerW/innerH */ }
    doc.addImage(img,'PNG',offX,offY,drawW,drawH);
    doc.setTextColor(51,65,85); doc.setFontSize(10);
    const title=chart.canvas.getAttribute('aria-label')||'';
    doc.text(title,x+6,y+8);
  }
  function addFooter(doc){ const pageW=doc.internal.pageSize.getWidth(); const pageH=doc.internal.pageSize.getHeight(); const txt=`P√°gina ${doc.internal.getNumberOfPages()}`; doc.setDrawColor(231,238,247); doc.line(12,pageH-10,pageW-12,pageH-10); doc.setTextColor(71,85,105); doc.setFontSize(8); doc.text(txt,pageW-12-doc.getTextWidth(txt),pageH-6); }
  function drawCover(doc,pageW,pageH,M){ doc.setFillColor(0,47,90); doc.rect(0,0,pageW,24,'F'); if(BRAND.logoDataURI){ doc.addImage(BRAND.logoDataURI,'PNG',M,4,18,18);} doc.setTextColor(255,255,255); doc.setFontSize(16); doc.text('Informe Ejecutivo ‚Äî Cotrafa Social',M+22,12); doc.setFontSize(9); doc.text(new Date().toLocaleString('es-CO'),M+22,19); doc.setTextColor(15,23,42); doc.setFontSize(26); doc.text('An√°lisis Integral',pageW/2,pageH/2-6,{align:'center'}); doc.setFontSize(11); doc.setTextColor(71,85,105); drawContactInfoCenter(doc, pageW/2, pageH/2+2); doc.setDrawColor(0,174,239); doc.setLineWidth(.6); doc.line(M,pageH-16,pageW-M,pageH-16); doc.setFontSize(9); doc.setTextColor(0,51,102); doc.text('Confidencial ‚Äî Uso interno',pageW/2,pageH-10,{align:'center'}); }
  function drawWatermark(doc,pageW,pageH){ const prev=doc.getTextColor(); doc.setFontSize(48); doc.setTextColor(180,196,210); doc.text(ORG.watermark,pageW/2,pageH/2,{angle:-25,align:'center'}); if(prev) doc.setTextColor(prev); }

  // ====== PDF helpers ======
  function sectionTitle(doc, title, x, y){ doc.setTextColor(15,23,42); doc.setFontSize(12); doc.text(String(title||''), x, y); }
  function getChartTitle(cid){ const chart=charts[cid]; return chart && chart.canvas ? chart.canvas.getAttribute('aria-label')||'' : ''; }
  function drawContactInfoRight(doc, xRight, y, onHeader=false){
    const dot='  ‚Ä¢  ';
    const nit=ORG.nit||''; const email=ORG.email||''; const tel=ORG.telefono||''; const web=ORG.web||'';
    const wNit=doc.getTextWidth(nit), wDot=doc.getTextWidth(dot), wEmail=doc.getTextWidth(email), wTel=doc.getTextWidth(tel), wWeb=doc.getTextWidth(web);
    let x = xRight - (wNit + wDot + wEmail + wDot + wTel + wDot + wWeb);
    const color = onHeader ? [255,255,255] : [71,85,105];
    doc.setTextColor(...color); doc.setFontSize(9);
    doc.text(nit, x, y); x += wNit; doc.text(dot, x, y); x += wDot;
    doc.text(email, x, y); doc.link(x, y-4, wEmail, 6, { url: `mailto:${email}` }); x += wEmail; doc.text(dot, x, y); x += wDot;
    const telHref = `tel:${String(tel).replace(/[^0-9+]/g,'')}`;
    doc.text(tel, x, y); doc.link(x, y-4, wTel, 6, { url: telHref }); x += wTel; doc.text(dot, x, y); x += wDot;
    doc.text(web, x, y); doc.link(x, y-4, wWeb, 6, { url: web });
  }
  function drawContactInfoCenter(doc, xCenter, y){
    const dot='  ‚Ä¢  ';
    const nit=ORG.nit||''; const email=ORG.email||''; const tel=ORG.telefono||''; const web=ORG.web||'';
    const parts=[nit, dot, email, dot, tel, dot, web];
    const widths=parts.map(p=>doc.getTextWidth(p));
    const total=widths.reduce((a,b)=>a+b,0);
    let x = xCenter - total/2;
    doc.setTextColor(71,85,105); doc.setFontSize(11);
    for(let i=0;i<parts.length;i++){
      const text=parts[i], w=widths[i];
      doc.text(text, x, y);
      if(i===2){ doc.link(x, y-5, w, 8, { url: `mailto:${email}` }); }
      if(i===4){ doc.link(x, y-5, w, 8, { url: `tel:${String(tel).replace(/[^0-9+]/g,'')}` }); }
      if(i===6){ doc.link(x, y-5, w, 8, { url: web }); }
      x += w;
    }
  }

  function editOrg(){
    try{
      const nombre = prompt('Nombre de la organizaci√≥n:', ORG.nombre||'')?.trim();
      if(nombre!==undefined && nombre!==null && nombre!=='') ORG.nombre=nombre;
      const nit = prompt('NIT:', ORG.nit||'')?.trim();
      if(nit!==undefined && nit!==null && nit!=='') ORG.nit=nit;
      const email = prompt('Correo electr√≥nico:', ORG.email||'')?.trim();
      if(email!==undefined && email!==null && email!=='') ORG.email=email;
      const tel = prompt('Tel√©fono:', ORG.telefono||'')?.trim();
      if(tel!==undefined && tel!==null && tel!=='') ORG.telefono=tel;
      const web = prompt('P√°gina web:', ORG.web||'')?.trim();
      if(web!==undefined && web!==null && web!=='') ORG.web=web;
      try{ localStorage.setItem('cotrafa_org_info', JSON.stringify({ nombre: ORG.nombre, nit: ORG.nit, email: ORG.email, telefono: ORG.telefono, web: ORG.web })); }catch(_){ }
      toast('Datos de organizaci√≥n actualizados');
    }catch(_){ alert('No se pudieron actualizar los datos de la organizaci√≥n.'); }
  }
  function getActiveFiltersText(){
    const parts=[];
    try{
      // Select-based filters
      const map=[['Ciudad','Ciudad'],['Estado','Estado'],['CategoriaEdad','Categor√≠a Edad']];
      map.forEach(([key,label])=>{ const sel=document.getElementById('filter-'+key); if(!sel) return; const vals=Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v!=='__all__'); if(vals.length) parts.push(`${label}: ${vals.join(', ')}`); });
      // Chart click filters
      const names={month:'Mes',year:'A√±o',categoriaEdad:'Cat. Edad',estado:'Estado',ciudad:'Ciudad',mesesSinPagarRange:'Meses sin pagar'};
      Object.entries(chartFilterState).forEach(([k,v])=>{ if(v) parts.push(`${names[k]}: ${v}`); });
    }catch(_){}
    return parts.length? `Filtros: ${parts.join('  ‚Ä¢  ')}` : '';
  }
  function captureChartImage(cid, widthMm, heightMm){
    try{
      const chart=charts[cid]; if(!chart||!chart.canvas) return null;
      const canvas=chart.canvas;
      const origW=canvas.width, origH=canvas.height;
      const PX_PER_MM=3.78; // ~96 DPI
      const targetW=Math.max(600, Math.floor(widthMm*PX_PER_MM));
      const targetH=Math.max(400, Math.floor(heightMm*PX_PER_MM));
      chart.resize(targetW, targetH);
      chart.update();
      const dataURL=canvas.toDataURL('image/png');
      chart.resize(origW, origH);
      chart.update();
      return dataURL;
    }catch(_){ return null; }
  }

  // ====== Executive summary helpers ======
  function buildInsights(){
    const insights=[];
    insights.push(`Pago promedio: ${pctPago()}`);
    insights.push(`No pago promedio: ${pctNoPago()}`);
    insights.push(`Cantidad filtrada: ${formatNumber(filteredData.length)}`);
    const cobertura = rawData.length ? (filteredData.length/rawData.length*100) : 0;
    insights.push(`Cobertura del conjunto: ${formatPercentage(cobertura)}`);
    return insights;
  }

  // Descarga robusta del PDF (evita bloqueos de pop‚Äëup y funciona cross‚Äëbrowser)
  function downloadPDF(doc, filename){
    try{
      const blob = doc.output('blob');
      // IE/Edge Legacy
      if (window.navigator && typeof window.navigator.msSaveOrOpenBlob === 'function'){
        window.navigator.msSaveOrOpenBlob(blob, filename);
        return;
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.rel = 'noopener';
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
    }catch(e){
      // √öltimo recurso: abrir en nueva pesta√±a
      try{
        const buf = doc.output('arraybuffer');
        const url = URL.createObjectURL(new Blob([buf], {type:'application/pdf'}));
        window.open(url,'_blank','noopener');
        setTimeout(()=>URL.revokeObjectURL(url), 5000);
      }catch(_){ console.error('Fallo al descargar el PDF:', e); }
    }
  }

  // ====== UI ======
  function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',bottom:'24px',right:'24px',padding:'10px 14px',background:'linear-gradient(135deg,var(--primary),var(--accent))',color:'#fff',borderRadius:'12px',boxShadow:'var(--shadow)',zIndex:9999,fontWeight:'700'}); document.body.appendChild(t); setTimeout(()=>t.remove(),2400); }

  // ====== Helpers ======
  function showLoading(show){ document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
  function formatNumber(num,dec=0){ return Number(num||0).toLocaleString('es-CO',{minimumFractionDigits:dec,maximumFractionDigits:dec}); }
  function formatPercentage(v){ return `${Number(v||0).toFixed(1)}%`; }
  </script>
</body>
</html>
