<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotrafa Social — Dashboard Ejecutivo (estable)</title>
  <link rel="icon" type="image/png" href="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root{--primary:#003366;--accent:#00AEEF;--success:#7CC242;--bg:#F5F7FB;--surface:#fff;--muted:#667085}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:#0f172a;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e7eef7;z-index:10}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{height:40px}
    .brand b{color:var(--primary)}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:999px;border:1px solid #dbe7f3;background:#fff;color:var(--primary);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border:none}
    main{padding:18px 0}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .panel{background:var(--surface);border:1px solid #e7eef7;border-radius:14px;padding:16px}
    h1{margin:4px 0 0;font-size:24px;color:#002f5a}
    h2{margin:0 0 10px;font-size:16px;color:#002f5a}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{background:linear-gradient(135deg,#fff,#f8fbff);border:1px solid #e7eef7;border-radius:12px;padding:14px}
    .kpi .l{font-size:12px;color:#334155}
    .kpi .v{font-size:22px;font-weight:800;color:var(--primary)}
    .charts{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px}
    canvas{width:100%!important;height:320px!important}
    footer{margin:26px 0 40px;color:var(--muted)}
    @media (max-width:980px){.row{grid-template-columns:1fr}.charts{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.charts{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <img alt="Logo Cotrafa" src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png"/>
        <b>Cotrafa Social</b>
      </div>
      <div class="actions">
        <button class="btn" id="btnLogo">Logo en PDF</button>
        <button class="btn primary" id="btnPDF">Informe PDF</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <section class="panel">
        <h2>Datos</h2>
        <input type="file" id="csv" accept=".csv" />
        <p class="help" style="color:var(--muted);font-size:12px">Si no cargas un CSV, verás <em>datos demo</em> para comprobar que todo funciona.</p>
      </section>
      <section class="panel">
        <h2>KPIs</h2>
        <div class="kpis">
          <div class="kpi"><div class="l">% Pago</div><div class="v" id="kpiPago">-</div></div>
          <div class="kpi"><div class="l">% No Pago</div><div class="v" id="kpiNoPago">-</div></div>
          <div class="kpi"><div class="l">Cantidad</div><div class="v" id="kpiCant">-</div></div>
          <div class="kpi"><div class="l">Cobertura</div><div class="v" id="kpiCov">-</div></div>
        </div>
      </section>
    </div>

    <section class="charts">
      <div class="panel"><h2>Afiliaciones por Mes</h2><canvas id="cMes"></canvas></div>
      <div class="panel"><h2>Afiliaciones por Año</h2><canvas id="cAno"></canvas></div>
      <div class="panel"><h2>Estados</h2><canvas id="cEstado"></canvas></div>
    </section>
  </main>

  <footer class="container">
    <div class="panel">© <span id="y"></span> Cotrafa Social — Versión estable</div>
  </footer>

  <input id="logoFile" type="file" accept="image/*" style="display:none" />

  <script>
    // ===== Estado básico
    let raw = [];
    let filtered = [];
    const BRAND = { logoDataURI: null, logoURL: 'https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png' };

    // ===== Utilidades
    const fmtN = (n)=> Number(n||0).toLocaleString('es-CO');
    const fmtP = (x)=> `${Number(x||0).toFixed(1)}%`;

    // ===== Demo data por si no hay CSV
    function demoData(n=120){
      const ciudades=['Medellín','Bello','Itagüí','Envigado','Rionegro'];
      const estados=['Activo','Inactivo','Suspendido'];
      const out=[]; for(let i=0;i<n;i++){
        const m = 1+Math.floor(Math.random()*12);
        const y = 2023 + Math.floor(Math.random()*3);
        const p = 60 + Math.random()*40; // 60-100
        out.push({ MesAfiliacion:m, AnoAfiliacion:y, Ciudad: ciudades[i%ciudades.length], Estado: estados[i%estados.length], PctPago:p, PctNoPago:100-p });
      }
      return out;
    }

    // ===== Carga CSV
    document.getElementById('csv').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f){ init(); return; }
      Papa.parse(f,{header:true,skipEmptyLines:true,complete:(res)=>{ raw = res.data.map(normalize); run(); }, error:()=>{ alert('CSV inválido. Se usarán datos demo.'); init(); }});
    });

    function normalize(r){
      const o={};
      for(const k in r){ if(!r.hasOwnProperty(k)) continue; const key=String(k).trim(); const v=String(r[k]??'').trim();
        if(/^mes/i.test(key)) o.MesAfiliacion = isNaN(parseInt(v))? null: parseInt(v);
        else if(/año|ano/i.test(key)) o.AnoAfiliacion = parseInt(v)||null;
        else if(/ciudad/i.test(key)) o.Ciudad = v;
        else if(/estado/i.test(key)) o.Estado = v;
        else if(/%\s*pago|pct.*pago/i.test(key)) o.PctPago = parseFloat(v.replace(',','.'))||0;
        else if(/%\s*no|pct.*no/i.test(key)) o.PctNoPago = parseFloat(v.replace(',','.'))||0;
      }
      if(o.PctPago==null && o.PctNoPago!=null) o.PctPago = 100 - o.PctNoPago;
      if(o.PctNoPago==null && o.PctPago!=null) o.PctNoPago = 100 - o.PctPago;
      return o;
    }

    // ===== KPIs
    function computeKPIs(){
      const t = filtered.length;
      let sp=0,sn=0,c=0; filtered.forEach(r=>{ if(r.PctPago!=null){ sp+=r.PctPago; sn+=r.PctNoPago??(100-r.PctPago); c++; }});
      const pago = c? sp/c : 0; const nopago = c? sn/c : 0;
      document.getElementById('kpiPago').textContent = fmtP(pago);
      document.getElementById('kpiNoPago').textContent = fmtP(nopago);
      document.getElementById('kpiCant').textContent = fmtN(t);
      document.getElementById('kpiCov').textContent = fmtP(raw.length? (t/raw.length*100):0);
    }

    // ===== Gráficos
    const charts={};
    function buildCharts(){
      const names=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      // Mes
      const cm={}; filtered.forEach(r=>{ const m=r.MesAfiliacion; if(m) cm[m]=(cm[m]||0)+1; });
      const lm=Object.keys(cm).sort((a,b)=>a-b).map(k=>names[k]); const dm=lm.map(l=> cm[names.indexOf(l)]||0);
      setBar('cMes', lm, dm, 'Afiliaciones');
      // Año
      const cy={}; filtered.forEach(r=>{ const y=r.AnoAfiliacion; if(y) cy[y]=(cy[y]||0)+1; });
      const ly=Object.keys(cy).sort(); const dy=ly.map(l=>cy[l]); setBar('cAno', ly, dy, 'Afiliaciones');
      // Estado
      const ce={}; filtered.forEach(r=>{ const e=r.Estado||'Desconocido'; ce[e]=(ce[e]||0)+1; });
      const le=Object.keys(ce); const de=le.map(l=>ce[l]); setBar('cEstado', le, de, 'Afiliados');
    }

    function setBar(id, labels, data, label){
      const ctx = document.getElementById(id).getContext('2d');
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{label, data, backgroundColor:['#003366','#00AEEF','#7CC242','#F39200','#004E8E','#00A6A6']}]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{grid:{color:'rgba(2,14,39,.06)'}}, y:{grid:{color:'rgba(2,14,39,.06)'}}} }
      });
    }

    // ===== PDF mínimo estable
    document.getElementById('btnPDF').addEventListener('click', async()=>{
      const { jsPDF } = window.jspdf; const doc = new jsPDF('l','mm','a4');
      const W=doc.internal.pageSize.getWidth();
      // Header
      doc.setFillColor(0,47,90); doc.rect(0,0,W,18,'F');
      doc.setTextColor(255,255,255); doc.setFontSize(12); doc.text('Informe Ejecutivo — Cotrafa Social', 10, 11);
      // KPIs
      doc.setTextColor(15,23,42); doc.setFontSize(10);
      const k = [ ['% Pago', document.getElementById('kpiPago').textContent], ['% No Pago', document.getElementById('kpiNoPago').textContent], ['Cantidad', document.getElementById('kpiCant').textContent], ['Cobertura', document.getElementById('kpiCov').textContent] ];
      const boxW=(W-20-18)/4; let x=10, y=24; k.forEach(([l,v])=>{ doc.setDrawColor(215,232,246); doc.roundedRect(x,y,boxW,18,2,2,'S'); doc.text(l,x+4,y+6); doc.setFontSize(14); doc.setTextColor(0,51,102); doc.text(v,x+4,y+14); doc.setFontSize(10); doc.setTextColor(15,23,42); x+=boxW+6; });
      // Charts (captura canvas)
      const ids=['cMes','cAno','cEstado']; const gW=130, gH=70; x=10; y=46;
      for(let i=0;i<ids.length;i++){
        const c = document.getElementById(ids[i]); if(!c) continue; const img = c.toDataURL('image/png');
        doc.roundedRect(x,y,gW,gH,2,2,'S'); doc.addImage(img,'PNG',x+2,y+4,gW-4,gH-8);
        if(i%2===1){ y+=gH+6; x=10; } else { x=10+gW+6; }
      }
      doc.save('informe_ejecutivo.pdf');
    });

    // ===== Logo base64 opcional para PDF
    document.getElementById('btnLogo').addEventListener('click',()=> document.getElementById('logoFile').click());
    document.getElementById('logoFile').addEventListener('change', async(e)=>{
      const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ BRAND.logoDataURI=fr.result; localStorage.setItem('cotrafa_logo', fr.result); alert('Logo fijado para PDF.'); }; fr.readAsDataURL(f);
    });
    (function(){ const s=localStorage.getItem('cotrafa_logo'); if(s) BRAND.logoDataURI=s; })();

    // ===== Arranque
    function init(){ raw = demoData(); run(); }
    function run(){ filtered = raw.slice(); computeKPIs(); buildCharts(); }

    document.getElementById('y').textContent = new Date().getFullYear();
    init();
  </script>
</body>
</html>
