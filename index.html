<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>An√°lisis Integral ‚Äî Dashboard Comercial (Cotrafa Social)</title>
  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png"/>
  <style>
    :root{--primary:#003366;--accent:#00AEEF;--success:#7CC242;--warning:#F39200;--navy:#002f5a;--bg:#F5F7FB;--surface:#fff;--ink:#0f172a;--muted:#475569;--ring:rgba(0,174,239,.35);--shadow:0 10px 30px rgba(2,14,39,.08);--radius:16px}
    *{box-sizing:border-box}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1,h2,h3{line-height:1.1;color:var(--navy)} h1{font-size:clamp(28px,3.6vw,40px)} h2{font-size:clamp(18px,2.2vw,22px)}
    .container{max-width:1220px;margin:0 auto;padding:0 20px}
    header.topbar{position:sticky;top:0;z-index:9;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #e9eff6}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:12px 0}
    .brand{display:flex;align-items:center;gap:12px}.brand img{height:42px}.brand .logotxt{font-weight:800;color:var(--primary)}
    .panel{background:var(--surface);border:1px solid #e7eef7;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .toolbar{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin:18px 0}
    .file{display:flex;flex-wrap:wrap;align-items:center;gap:12px}
    .file input[type=file]{padding:10px;border-radius:12px;border:1px dashed #cfe5f4;background:#fafcff}
    .filters{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .filter{display:flex;flex-direction:column;gap:6px}
    .filter label{font-size:12px;font-weight:700;color:#334155}
    .filter input, .filter select{padding:10px;border-radius:12px;border:1px solid #dbe7f3;background:#fff}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;font-weight:700;border:1px solid transparent;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff}
    .btn-outline{background:#fff;border-color:#dbe7f3;color:var(--primary)}
    .btn-warning{background:linear-gradient(135deg,var(--warning),#ffc46b);color:#432c00}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#f1f7fb;border:1px solid #d7e8f6;color:#0b3a57;padding:6px 10px;border-radius:999px;font-size:12px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin:12px 0 22px}
    .kpi{position:relative;background:linear-gradient(135deg,#fff,#f7fbff);border:1px solid #e7eef7;border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    .kpi .label{display:flex;align-items:center;gap:8px;color:#334155;font-size:12px;font-weight:700}
    .kpi .value{font-size:26px;font-weight:800;color:var(--primary);margin-top:6px}
    .charts{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .card{background:var(--surface);border:1px solid #e7eef7;border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px;font-size:16px}
    .card canvas{width:100%!important;height:320px!important}
    footer{margin:26px 0 40px}.foot{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between}.small{font-size:12px;color:#64748b}
    @media (max-width:1100px){.toolbar{grid-template-columns:1fr}.charts{grid-template-columns:1fr 1fr}}
    @media (max-width:720px){.filters{grid-template-columns:1fr}.kpis{grid-template-columns:1fr 1fr}.charts{grid-template-columns:1fr}}
    :focus-visible{outline:3px solid var(--ring);outline-offset:3px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container nav">
      <div class="brand" aria-label="Cotrafa Social">
        <img src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Logo Cotrafa Social"/>
        <span class="logotxt">Cotrafa Social</span>
      </div>
      <div class="actions">
        <button class="btn btn-outline" id="btnResetAll" title="Limpiar filtros">üßπ Limpiar</button>
        <button class="btn btn-outline" id="btnLogoBase64" title="Fijar logo en PDF (base64)">üñºÔ∏è Logo en PDF</button>
        <button class="btn btn-primary" id="btnReport" title="Descargar informe ejecutivo">üìÑ Informe PDF</button>
      </div>
    </div>
    <input id="logoFile" type="file" accept="image/*" style="display:none" />
  </header>

  <main class="container">
    <section class="toolbar">
      <div class="panel" aria-labelledby="tituloCarga">
        <h2 id="tituloCarga">Cargar datos</h2>
        <div class="file">
          <input type="file" id="csvFile" accept=".csv" aria-label="Seleccionar archivo CSV"/>
          <div class="meta">CSV con ; o , en UTF‚Äë8.</div>
        </div>
        <div class="chips" id="chips"></div>
      </div>
      <div class="panel" aria-labelledby="tituloFiltros">
        <h2 id="tituloFiltros">Filtros</h2>
        <div class="filters" id="filters"></div>
        <div class="actions"><button class="btn btn-warning" id="btnRefresh">‚Üª Refrescar filtros</button></div>
      </div>
    </section>

    <section class="kpis" id="kpiSection"></section>

    <section class="charts" id="chartSection"></section>
  </main>

  <footer class="container">
    <div class="panel foot">
      <div class="brand">
        <img src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Logo Cotrafa Social"/>
        <div>
          <div class="logotxt">Cotrafa Social</div>
          <div class="small">Dashboard comercial ‚Äî versi√≥n ejecutiva y accesible</div>
        </div>
      </div>
      <div class="small">¬© <span id="year"></span> Cotrafa Social ‚Ä¢ Reporte PDF y filtros por clic</div>
    </div>
  </footer>

  <div id="loading" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999;color:#fff;font-weight:800">Cargando datos‚Ä¶</div>

  <script>
  // ====== Marca & Organizaci√≥n ======
  const BRAND = { logoURL:'https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png', logoDataURI:null };
  const ORG = { nombre:'Cotrafa Social', nit:'NIT 000.000.000-0', email:'contacto@cotrafasocial.com', telefono:'+57 (000) 000 00 00', web:'https://cotrafasocial.com', watermark:'COTRAFA SOCIAL ‚Äî CONFIDENCIAL' };
  (function(){ try{const s=localStorage.getItem('cotrafa_logo_base64'); if(s) BRAND.logoDataURI=s;}catch(e){} preloadLogo(); })();
  async function preloadLogo(){ if(BRAND.logoDataURI) return; try{ const r=await fetch(BRAND.logoURL,{mode:'cors'}); const b=await r.blob(); BRAND.logoDataURI=await blobToDataURL(b);}catch(e){} }
  function blobToDataURL(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }

  // ====== Estado ======
  let rawData=[]; let filteredData=[]; const charts={};
  const filterConfigs=[{key:'Ciudad',label:'Ciudad'},{key:'Estado',label:'Estado'},{key:'CategoriaEdad',label:'Categor√≠a Edad'}];
  const chartFilterState={month:null,year:null,categoriaEdad:null,estado:null,ciudad:null,mesesSinPagarRange:null};
  const chartDimensionMap={ chartMesAfiliacion:'month', chartAnoAfiliacion:'year', chartCategoriaEdad:'categoriaEdad', chartEstado:'estado', chartCiudad:'ciudad', chartMesesSinPagar:'mesesSinPagarRange'};
  Chart.defaults.font.family='Inter, system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif'; Chart.defaults.color='#334155';

  // ====== Inicio ======
  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('year').textContent=new Date().getFullYear();
    initFilters(); initKPISection(); initCharts();
    document.getElementById('csvFile').addEventListener('change',handleFileUpload);
    document.getElementById('btnResetAll').addEventListener('click',resetAll);
    document.getElementById('btnReport').addEventListener('click',generateReport);
    document.getElementById('btnRefresh').addEventListener('click',()=>{populateFilterOptions(); applyFilters();});
    const logoBtn=document.getElementById('btnLogoBase64'); const logoFile=document.getElementById('logoFile');
    logoBtn.addEventListener('click',()=>logoFile.click());
    logoFile.addEventListener('change',async(e)=>{ const f=e.target.files[0]; if(!f) return; const dataURL=await blobToDataURL(f); BRAND.logoDataURI=dataURL; try{localStorage.setItem('cotrafa_logo
