<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Análisis Integral — Dashboard Comercial (Cotrafa Social)</title>
  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ─────────────────────────────────────────────────────────────────────────────
       Informe PDF
    ───────────────────────────────────────────────────────────────────────────── */

    function toast(msg){
      const t = document.createElement('div'); t.textContent = msg;
      Object.assign(t.style,{position:'fixed',bottom:'24px',right:'24px',padding:'10px 14px',background:'linear-gradient(135deg,var(--primary),var(--accent))',color:'#fff',borderRadius:'12px',boxShadow:'var(--shadow)',zIndex:9999,fontWeight:'700'});
      document.body.appendChild(t); setTimeout(()=>t.remove(),2400);
    }

    function drawCover(doc, pageW, pageH, M){
      doc.setFillColor(0,47,90); doc.rect(0,0,pageW,24,'F');
      if(BRAND.logoDataURI){ doc.addImage(BRAND.logoDataURI,'PNG', M, 4, 18, 18); }
      doc.setTextColor(255,255,255); doc.setFontSize(16); doc.text('Informe Ejecutivo — Cotrafa Social', M+22, 12);
      doc.setFontSize(9); doc.text(new Date().toLocaleString('es-CO'), M+22, 19);
      doc.setTextColor(15,23,42); doc.setFontSize(26);
      doc.text('Análisis Integral', pageW/2, pageH/2 - 6, {align:'center'});
      doc.setFontSize(11); doc.setTextColor(71,85,105);
      const sub = `${ORG.nit}  •  ${ORG.email}  •  ${ORG.telefono}  •  ${ORG.web}`;
      doc.text(sub, pageW/2, pageH/2 + 2, {align:'center'});
      doc.setDrawColor(0,174,239); doc.setLineWidth(0.6); doc.line(M, pageH-16, pageW-M, pageH-16);
      doc.setFontSize(9); doc.setTextColor(0,51,102); doc.text('Confidencial — Uso interno', pageW/2, pageH-10, {align:'center'});
    }

    function drawWatermark(doc, pageW, pageH){
      const prevColor = doc.getTextColor();
      doc.setFontSize(48);
      doc.setTextColor(180, 196, 210);
      doc.text(ORG.watermark, pageW/2, pageH/2, {angle: -25, align:'center'});
      if(prevColor) doc.setTextColor(prevColor);
    }

    function drawHeader(doc){
      const pageW = doc.internal.pageSize.getWidth();
      const headH = 20; doc.setFillColor(0,47,90); doc.rect(0,0,pageW,headH,'F'); if(BRAND.logoDataURI){ doc.addImage(BRAND.logoDataURI,'PNG',10,3,14,14); }
      doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text('Informe Ejecutivo — Cotrafa Social', 28, 8); doc.setFontSize(9); doc.text(new Date().toLocaleString('es-CO'), 28, 15);
      doc.setFontSize(8); const info = `${ORG.nit}  •  ${ORG.email}  •  ${ORG.telefono}  •  ${ORG.web}`; const w = doc.getTextWidth(info);
      doc.text(info, pageW - 10 - w, 15);
    }

    function drawKPI(doc,x,y,w,h,label,value){
      doc.setDrawColor(215,232,246); doc.setFillColor(255,255,255); doc.roundedRect(x,y,w,h,2,2,'FD');
      doc.setTextColor(51,65,85); doc.setFontSize(9); doc.text(label, x+4, y+6);
      doc.setTextColor(0,51,102); doc.setFontSize(14); doc.text(String(value), x+4, y+14);
    }

    // === Helpers para PDF robusto ===
if (typeof wait === 'undefined') { var wait = (ms)=> new Promise(r=>setTimeout(r, ms)); }
if (typeof logErr === 'undefined') { var logErr = function(scope, err){ console.error(`[PDF:${scope}]`, err); }; }

function drawChartCard(doc,x,y,w,h,cid){
  try{
    doc.setDrawColor(215,232,246);
    doc.setFillColor(255,255,255);
    doc.roundedRect(x,y,w,h,2,2,'FD');
    const chart = charts[cid];
    // Si no hay chart o no está listo, muestro etiqueta y sigo
    if(!chart || !chart.canvas){
      doc.setTextColor(120,130,140);
      doc.setFontSize(9);
      doc.text('Gráfico no disponible', x+4, y+10);
      return;
    }
    // Asegura que el chart esté actualizado antes del snapshot
    try { chart.update('none'); } catch(e) { /* ignore */ }
    const img = chart.canvas.toDataURL('image/png');
    doc.addImage(img, 'PNG', x+2, y+6, w-4, h-10);
    doc.setTextColor(51,65,85); doc.setFontSize(9);
    const title = chart.canvas.getAttribute('aria-label') || '';
    if(title) doc.text(title, x+4, y+4);
  }catch(err){
    logErr(`drawChartCard:${cid}`, err);
    // Caja con mensaje de error suave en vez de romper el PDF
    doc.setDrawColor(240, 150, 150);
    doc.roundedRect(x,y,w,h,2,2,'S');
    doc.setTextColor(150,50,50); doc.setFontSize(9);
    doc.text('No se pudo exportar este gráfico.', x+4, y+10);
  }
}

    function addFooter(doc){
      const pageW = doc.internal.pageSize.getWidth(); const pageH = doc.internal.pageSize.getHeight();
      const txt = `Página ${doc.internal.getNumberOfPages()}`;
      doc.setDrawColor(231,238,247); doc.line(12, pageH-10, pageW-12, pageH-10);
      doc.setTextColor(71,85,105); doc.setFontSize(8); doc.text(txt, pageW-12 - doc.getTextWidth(txt), pageH-6);
    }

    function buildInsights(){
      const out = [];
      const names=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      const mCount={}; filteredData.forEach(r=>{ const m=r.MesAfiliacion? parseInt(r.MesAfiliacion,10): null; if(m) mCount[m]=(mCount[m]||0)+1; });
      if(Object.keys(mCount).length){ const topM = Object.entries(mCount).sort((a,b)=>b[1]-a[1])[0]; out.push(`El mes con más afiliaciones fue ${names[topM[0]]} con ${formatNumber(topM[1])} registros.`); }
      const yCount={}; filteredData.forEach(r=>{ const y=r.AnoAfiliacion; if(y) yCount[y]=(yCount[y]||0)+1; });
      if(Object.keys(yCount).length){ const topY = Object.entries(yCount).sort((a,b)=>b[1]-a[1])[0]; out.push(`El año más activo fue ${topY[0]} con ${formatNumber(topY[1])} afiliaciones.`); }
      const cCount={}; filteredData.forEach(r=>{ const c=r.Ciudad||'Desconocido'; cCount[c]=(cCount[c]||0)+1; });
      if(Object.keys(cCount).length){ const topC = Object.entries(cCount).sort((a,b)=>b[1]-a[1])[0]; out.push(`La ciudad líder fue ${topC[0]} con ${formatNumber(topC[1])} afiliados.`); }
      const ranges=[{label:'0',min:0,max:0},{label:'1-3',min:1,max:3},{label:'4-6',min:4,max:6},{label:'7-12',min:7,max:12},{label:'>12',min:13,max:Infinity}];
      const rCount={}; ranges.forEach(r=>rCount[r.label]=0); filteredData.forEach(r=>{ const v=r.Meses_sin_pagar!==undefined? r.Meses_sin_pagar : null; if(v!==null && !isNaN(v)){ const R=ranges.find(x=>v>=x.min && v<=x.max); if(R) rCount[R.label]++; }});
      const topR = Object.entries(rCount).sort((a,b)=>b[1]-a[1])[0]; if(topR && topR[1]>0){ out.push(`El rango más frecuente de meses sin pago es ${topR[0]} (${formatNumber(topR[1])} casos).`); }
      out.push(`Pago promedio: ${pctPago()} • No pago promedio: ${pctNoPago()}.`);
      if(!out.length) out.push('No hay suficientes datos filtrados para generar hallazgos.');
      return out;
    }

    function buildMethodology(){
      const actives = [];
      const selectSummary = [];
      (filterConfigs||[]).forEach(cfg=>{
        const sel = document.getElementById('filter-'+cfg.key); if(!sel) return;
        const val = Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v!=='__all__');
        if(val.length) selectSummary.push(`${cfg.label}: ${val.join(', ')}`);
      });
      if(selectSummary.length) actives.push('Filtros aplicados — ' + selectSummary.join(' • '));
      const map = {month:'Mes', year:'Año', categoriaEdad:'Categoría Edad', estado:'Estado', ciudad:'Ciudad', mesesSinPagarRange:'Meses sin pagar'};
      const clickFilters = Object.entries(chartFilterState).filter(([k,v])=>!!v).map(([k,v])=>`${map[k]}: ${v}`);
      if(clickFilters.length) actives.push('Segmentación gráfica — ' + clickFilters.join(' • '));
      return [
        'Fuentes: archivo CSV cargado por el usuario (delimitado por coma o punto y coma, UTF‑8).',
        actives.length? actives.join(' | ') : 'Sin filtros activos al momento del reporte.',
        'Definiciones: % Pago/No Pago estimado con base en columnas PctPago/PctNoPago o, en su defecto, CuotasPagadas/MesesAfiliado.',
        'Los gráficos se exportan desde el estado visible del dashboard (Chart.js).',
        'El informe se genera automáticamente y está optimizado para lectura en pantalla y A4 horizontal para impresión.'
      ];
    }

    function formatNumber(num,dec=0){ return Number(num||0).toLocaleString('es-CO',{minimumFractionDigits:dec,maximumFractionDigits:dec}); }
    function formatPercentage(v){ return `${Number(v||0).toFixed(1)}%`; }

    async function generateReport(){
  try{
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert('No se pudo cargar jsPDF.'); return;
    }
    const { jsPDF } = window.jspdf;

    // Espera breve por si acabas de aplicar filtros o renderizar charts
    await wait(150);

    const doc = new jsPDF('l','mm','a4');
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const M = 14;

    // Portada
    try{
      drawCover(doc, pageW, pageH, M);
      drawWatermark(doc, pageW, pageH);
    }catch(e){ logErr('cover', e); }

    // Resumen + KPIs
    doc.addPage('a4','l');
    try{
      drawHeader(doc);
      const resumen = buildInsights();
      const metodologia = buildMethodology();
      let y = 28;

      doc.setTextColor(15,23,42); doc.setFontSize(14);
      doc.text('Resumen Ejecutivo', M, y); y += 6;
      doc.setFontSize(9); doc.setTextColor(51,65,85);
      resumen.forEach(line=>{
        const used = doc.splitTextToSize('• '+line, pageW - 2*M);
        doc.text(used, M, y);
        y += (used.length*4 + 2);
      });
      y += 4;

      doc.setTextColor(15,23,42); doc.setFontSize(12);
      doc.text('Nota metodológica', M, y); y += 5;
      doc.setFontSize(8); doc.setTextColor(71,85,105);
      metodologia.forEach(line=>{
        const used = doc.splitTextToSize(line, pageW - 2*M);
        doc.text(used, M, y);
        y += (used.length*4 + 1);
      });
      drawWatermark(doc, pageW, pageH);

      // KPIs
      const kpiY = y + 2;
      const boxW = (pageW - 2*M - 3*6)/4;
      const kpiVals = [
        ['% Pago', pctPago()],
        ['% No Pago', pctNoPago()],
        ['Cantidad', formatNumber(filteredData.length)],
        ['Cobertura', formatPercentage(rawData.length ? (filteredData.length/rawData.length*100) : 0)]
      ];
      for(let i=0;i<4;i++){
        const x = M + i*(boxW+6);
        drawKPI(doc, x, kpiY, boxW, 20, kpiVals[i][0], kpiVals[i][1]);
      }
      drawWatermark(doc, pageW, pageH);
    }catch(e){ logErr('resumen_kpi', e); }

    // Gráficos (2x2 por página)
    try{
      const gW = (pageW - 2*M - 6)/2;
      const gH = 70;
      let gy = 28 + 26 + 26; // punto razonable tras el bloque anterior
      const chartsIds = [
        'chartMesAfiliacion','chartAnoAfiliacion',
        'chartCategoriaEdad','chartEstado',
        'chartCiudad','chartMesesSinPagar'
      ];

      for(let i=0;i<chartsIds.length;i++){
        if(i>0 && i%4===0){
          addFooter(doc);
          doc.addPage('a4','l');
          drawHeader(doc);
          gy = 28;
          drawWatermark(doc, pageW, pageH);
          await wait(50); // pequeña pausa entre páginas
        }
        const col = i%2; 
        const row = Math.floor((i%4)/2);
        const x = M + col*(gW+6);
        const yy = gy + row*(gH+6);
        drawChartCard(doc, x, yy, gW, gH, chartsIds[i]);

        if(i%4===3){
          gy += 2*(gH+6);
          drawWatermark(doc, pageW, pageH);
        }
      }
    }catch(e){ logErr('graficos', e); }

    // Pie y guardar
    try{ addFooter(doc); drawWatermark(doc, pageW, pageH); }catch(e){ /* no crítico */ }
    doc.save('informe_ejecutivo.pdf');

  }catch(err){
    logErr('fatal', err);
    alert('Error al generar el informe. Abre la consola (F12 → Console) para ver detalles y te lo corrijo.');
  }
}
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l','mm','a4');
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const M = 14;

        drawCover(doc, pageW, pageH, M);
        drawWatermark(doc, pageW, pageH);

        doc.addPage('a4','l');
        drawHeader(doc);
        const resumen = buildInsights();
        const metodologia = buildMethodology();
        let y = 28;
        doc.setTextColor(15,23,42); doc.setFontSize(14); doc.text('Resumen Ejecutivo', M, y); y += 6;
        doc.setFontSize(9); doc.setTextColor(51,65,85);
        resumen.forEach(line=>{ const used = doc.splitTextToSize('• '+line, pageW - 2*M); doc.text(used, M, y); y += (used.length*4 + 2); });
        y += 4;
        doc.setTextColor(15,23,42); doc.setFontSize(12); doc.text('Nota metodológica', M, y); y += 5;
        doc.setFontSize(8); doc.setTextColor(71,85,105);
        metodologia.forEach(line=>{ const used = doc.splitTextToSize(line, pageW - 2*M); doc.text(used, M, y); y += (used.length*4 + 1); });
        drawWatermark(doc, pageW, pageH);

        const kpiY = y + 2;
        const boxW = (pageW - 2*M - 3*6)/4;
        const kpiVals = [ ['% Pago', pctPago()], ['% No Pago', pctNoPago()], ['Cantidad', formatNumber(filteredData.length)], ['Cobertura', formatPercentage(rawData.length? (filteredData.length/rawData.length*100) : 0)] ];
        for(let i=0;i<4;i++){
          const x = M + i*(boxW+6);
          drawKPI(doc, x, kpiY, boxW, 20, kpiVals[i][0], kpiVals[i][1]);
        }
        drawWatermark(doc, pageW, pageH);

        const gW = (pageW - 2*M - 6)/2;
        const gH = 70;
        let gy = kpiY + 26;
        const chartsIds = ['chartMesAfiliacion','chartAnoAfiliacion','chartCategoriaEdad','chartEstado','chartCiudad','chartMesesSinPagar'];
        for(let i=0;i<chartsIds.length;i++){
          if(i>0 && i%4===0){ addFooter(doc); doc.addPage('a4','l'); drawHeader(doc); gy = 28; drawWatermark(doc, pageW, pageH); }
          const col = i%2; const row = Math.floor((i%4)/2);
          const x = M + col*(gW+6);
          const yy = gy + row*(gH+6);
          drawChartCard(doc, x, yy, gW, gH, chartsIds[i]);
          if(i%4===3){ gy += 2*(gH+6); drawWatermark(doc, pageW, pageH); }
        }
        addFooter(doc);
        drawWatermark(doc, pageW, pageH);
        doc.save('informe_ejecutivo.pdf');
      }catch(err){ console.error(err); alert('Error al generar el informe.'); }
    }
  </script>
</body>
</html>
